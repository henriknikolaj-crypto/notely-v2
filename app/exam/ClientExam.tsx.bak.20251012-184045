"use client";
import { useEffect, useMemo, useState } from "react";
import SenesteVurderinger from "./SenesteVurderinger";

type EvalApiResponse = {
  feedback: string;
  session_id?: string | null;
  latency_ms?: number;
  tokens?: { prompt_tokens?: number; completion_tokens?: number; total_tokens?: number };
  doc_chunk_count?: number;
};
type EvalResult = { score: number | null; feedback: string; sessionId?: string | null };
export default function ClientExam({ userEmail }: { userEmail?: string }) {
  const [question, setQuestion] = useState("");
  const [answer, setAnswer] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);
  const [res, setRes] = useState<EvalResult | null>(null);

  const canSubmit = useMemo(() => answer.trim().length > 0 && !loading, [answer, loading]);

  async function onSubmit() {
    if (!canSubmit) return;
    setLoading(true);
    setErr(null);
    setRes(null);
    try {
      const r = await fetch("/api/evaluate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: question || null, answer }),
      });
      if (!r.ok) {
        // vis kort, klar fejltekst
        const msg = `HTTP ${r.status}`;
        throw new Error(msg);
      }
      const data: EvalApiResponse = await r.json();

      setRes({
        score: null, // vi scorer ikke endnu – kan udfyldes, når /api/evaluate returnerer en score
        feedback: data.feedback ?? "—",
        sessionId: data.session_id ?? null,
      });

      // Bed “Seneste vurderinger” om at refetche (lille custom event)
      if (typeof window !== "undefined") {
        window.dispatchEvent(new CustomEvent("exam:updated"));
      }
    } catch (e: any) {
      setErr(e?.message ?? "Uventet fejl");
    } finally {
      setLoading(false);
    }
  }

  // Ctrl/Cmd + Enter for at sende
  useEffect(() => {
    const onKey = (e: KeyboardEvent) => {
      if (e.key === "Enter" && (e.ctrlKey || (e as any).metaKey)) onSubmit();
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [answer, question, loading]);

  return (
    <main className="mx-auto max-w-3xl p-6">
      {/* Header */}
      <div className="mb-6"><h1 className="text-3xl font-semibold tracking-tight">Eksamensfeedback</h1><p className="mb-2 text-sm">Logget ind som <b>{userEmail}</b></p><p className="mt-1 text-neutral-600">
          Indsæt dit spørgsmål (valgfrit) og dit svar. Retrieval henter dine noter i baggrunden.
        </p></div>

      {/* Form-kort */}
      <section className="rounded-2xl border border-neutral-200 bg-white p-5 shadow-sm"><div className="grid gap-4"><label className="grid gap-1"><span className="text-sm font-medium text-neutral-800">Spørgsmål (valgfrit)</span><textarea
              value={question}
              onChange={(e) => setQuestion(e.target.value)}
              placeholder="Fx: Redegør for begrebet …"
              rows={3}
              className="w-full rounded-xl border border-neutral-300 bg-neutral-50 p-3 leading-relaxed placeholder:text-neutral-400 focus:border-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-900/10"
            /></label><label className="grid gap-1"><span className="text-sm font-medium text-neutral-800">Dit svar</span><textarea
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              placeholder="Skriv eller indsæt dit svar her…"
              rows={6}
              className="w-full rounded-xl border border-neutral-300 bg-neutral-50 p-3 leading-relaxed placeholder:text-neutral-400 focus:border-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-900/10"
            /></label><div className="flex items-center gap-3"><button
              onClick={onSubmit}
              disabled={!canSubmit}
              className="inline-flex items-center gap-2 rounded-xl bg-neutral-900 px-4 py-2 text-white transition-colors hover:bg-neutral-800 disabled:cursor-not-allowed disabled:bg-neutral-300"
              aria-busy={loading}
              title="Ctrl+Enter sender"
            >
              {loading && (
                <span
                  className="inline-block h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"
                  aria-hidden
                />
              )}
              {loading ? "Vurderer…" : "Få feedback"}
            </button><span className="text-sm text-neutral-500">Tip: Ctrl+Enter for at sende</span></div>

          {err && (
            <div className="rounded-xl border border-red-300 bg-red-50 p-3 text-red-800"><strong>Fejl:</strong> {err}
            </div>
          )}
        </div></section>

      {/* Resultat-kort */}
      {res && (
        <section className="mt-6 rounded-2xl border border-neutral-200 bg-white p-5 shadow-sm"><div className="mb-2 flex items-center gap-3"><h2 className="text-xl font-semibold">Feedback</h2><span className="rounded-full bg-neutral-900 px-2.5 py-0.5 text-sm font-medium text-white">
              {res.score ?? "—"}/10
            </span>
            {res.sessionId && <span className="text-sm text-neutral-500">#{res.sessionId}</span>}
          </div><div className="prose prose-neutral max-w-none whitespace-pre-wrap leading-relaxed">
            {res.feedback}
          </div></section>
      )}

      {/* Seneste vurderinger */}
      <section className="mt-8"><h2 className="text-lg font-semibold">Seneste vurderinger</h2><SenesteVurderinger /></section></main>
  );
}









